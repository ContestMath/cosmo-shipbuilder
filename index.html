<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Placement</title>
    <style>
        canvas {
            border: 1px solid #000;
        }

        #previewSprite {
            position: absolute;
            opacity: 0.7;
            pointer-events: none;
            /* Allow interaction with canvas below */
        }
    </style>
</head>

<body>
    <canvas id="spriteCanvas" width="64" height="64"></canvas>
    <textarea id="jsonInput"></textarea>
    <button id="loadButton">Load JSON</button>

    <script>
        const spriteData = {
            "cosmoteer.corridor": { "mass": 1, "size": [1, 1] },
            "cosmoteer.structure": { "mass": 0.33, "size": [1, 1] },
            "cosmoteer.structure_wedge": { "mass": 0.17, "size": [1, 1] },
            "cosmoteer.structure_1x2_wedge": { "mass": 0.33, "size": [1, 2] },
            "cosmoteer.structure_1x3_wedge": { "mass": 0.5, "size": [1, 3] },
            "cosmoteer.structure_tri": { "mass": 0.08, "size": [1, 1] },
            "cosmoteer.laser_blaster_small": { "mass": 2.5, "size": [1, 2], "sprite_size": [1, 4] },
            "cosmoteer.laser_blaster_large": { "mass": 7.68, "size": [2, 3], "sprite_size": [2, 6] },
            "cosmoteer.disruptor": { "mass": 3.48, "size": [1, 3], "sprite_size": [1, 5] },
            "cosmoteer.ion_beam_emitter": { "mass": 8, "size": [2, 4], "sprite_size": [2, 5] },
            "cosmoteer.resource_collector": { "mass": 4, "size": [2, 2] },
            "cosmoteer.ion_beam_prism": { "mass": 7.7, "size": [2, 2], "sprite_size": [2, 2.5] },
            "cosmoteer.tractor_beam_emitter": { "mass": 32.07, "size": [5, 5] },
            "cosmoteer.point_defense": { "mass": 1, "size": [1, 1], "sprite_size": [1, 2] },
            "cosmoteer.mining_laser_small": { "mass": 7.4, "size": [2, 3] },
            "cosmoteer.cannon_med": { "mass": 4.44, "size": [2, 1], "sprite_size": [2, 3] },
            "cosmoteer.sensor_array": { "mass": 11.54, "size": [3, 3] },
            "cosmoteer.cannon_large": { "mass": 12.29, "size": [3, 2], "sprite_size": [3, 5] },
            "cosmoteer.hyperdrive_beacon": { "mass": 17.13, "size": [4, 4] },
            "cosmoteer.cannon_deck": { "mass": 27.07, "size": [4, 5], "sprite_size": [4, 7] },
            "cosmoteer.explosive_charge": { "mass": 1, "size": [1, 1] },
            "cosmoteer.roof_light": { "mass": 1, "size": [1, 1] },
            "cosmoteer.missile_launcher": { "mass": 8, "size": [2, 3], "sprite_size": [2, 4] },
            "cosmoteer.roof_headlight": { "mass": 1, "size": [1, 1] },
            "cosmoteer.railgun_loader": { "mass": 24, "size": [2, 3] },
            "cosmoteer.armor_structure_hybrid_1x1": { "mass": 1.5, "size": [1, 1] },
            "cosmoteer.armor_structure_hybrid_1x2": { "mass": 3, "size": [1, 2] },
            "cosmoteer.railgun_accelerator": { "mass": 36, "size": [2, 3] },
            "cosmoteer.armor_structure_hybrid_1x3": { "mass": 4.5, "size": [1, 3] },
            "cosmoteer.armor_structure_hybrid_tri": { "mass": 1, "size": [1, 1] },
            "cosmoteer.railgun_launcher": { "mass": 36, "size": [2, 3], "sprite_size": [2, 4] },
            "cosmoteer.armor": { "mass": 3, "size": [1, 1] },
            "cosmoteer.armor_2x1": { "mass": 6, "size": [2, 1] },
            "cosmoteer.flak_cannon_large": { "mass": 16.77, "size": [3, 6], "sprite_size": [3, 8] },
            "cosmoteer.armor_wedge": { "mass": 1.5, "size": [1, 1] },
            "cosmoteer.armor_1x2_wedge": { "mass": 3, "size": [1, 2] },
            "cosmoteer.shield_gen_small": { "mass": 6, "size": [2, 2], "sprite_size": [2, 3] },
            "cosmoteer.armor_1x3_wedge": { "mass": 4.5, "size": [1, 3] },
            "cosmoteer.armor_tri": { "mass": 0.75, "size": [1, 1] },
            "cosmoteer.shield_gen_large": { "mass": 12.65, "size": [3, 6] },
            "cosmoteer.thruster_small": { "mass": 1.3, "size": [1, 1], "sprite_size": [1, 2] },
            "cosmoteer.thruster_med": { "mass": 2.45, "size": [1, 2], "sprite_size": [1, 3] },
            "cosmoteer.thruster_large": { "mass": 4.99, "size": [2, 2], "sprite_size": [2, 3] },
            "cosmoteer.thruster_boost": { "mass": 8.88, "size": [2, 3], "sprite_size": [2, 5] },
            "cosmoteer.fire_extinguisher": { "mass": 1, "size": [1, 1] },
            "cosmoteer.thruster_huge": { "mass": 11, "size": [3, 3], "sprite_size": [3, 5] },
            "cosmoteer.control_room_small": { "mass": 4, "size": [2, 2] },
            "cosmoteer.control_room_med": { "mass": 9, "size": [3, 3] },
            "cosmoteer.thruster_small_2way": { "mass": 1.61, "size": [1, 1], "sprite_size": [2, 2] },
            "cosmoteer.control_room_large": { "mass": 16, "size": [4, 4] },
            "cosmoteer.thruster_small_3way": { "mass": 1.91, "size": [1, 1], "sprite_size": [3, 2] },
            "cosmoteer.hyperdrive_small": { "mass": 4, "size": [2, 2] },
            "cosmoteer.engine_room": { "mass": 9, "size": [3, 3] },
            "cosmoteer.crew_quarters_small": { "mass": 2, "size": [1, 2] },
            "cosmoteer.crew_quarters_med": { "mass": 4, "size": [2, 2] },
            "cosmoteer.airlock": { "mass": 1, "size": [1, 1] },
            "cosmoteer.conveyor": { "mass": 1, "size": [1, 1] },
            "cosmoteer.reactor_small": { "mass": 4, "size": [2, 2] },
            "cosmoteer.reactor_med": { "mass": 9, "size": [3, 3] },
            "cosmoteer.reactor_large": { "mass": 16, "size": [4, 4] },
            "cosmoteer.power_storage": { "mass": 4, "size": [2, 2] },
            "cosmoteer.factory_ammo": { "mass": 4, "size": [2, 2] },
            "cosmoteer.factory_he": { "mass": 9, "size": [3, 3] },
            "cosmoteer.factory_emp": { "mass": 12, "size": [3, 4] },
            "cosmoteer.factory_nuke": { "mass": 16, "size": [4, 4] },
            "cosmoteer.factory_mine": { "mass": 12, "size": [4, 3] },
            "cosmoteer.factory_steel": { "mass": 16, "size": [4, 4] },
            "cosmoteer.factory_coil": { "mass": 9, "size": [3, 3] },
            "cosmoteer.factory_coil2": { "mass": 12, "size": [4, 3] },
            "cosmoteer.factory_tristeel": { "mass": 16, "size": [4, 4] },
            "cosmoteer.factory_diamond": { "mass": 6, "size": [2, 3] },
            "cosmoteer.factory_processor": { "mass": 9, "size": [3, 3] },
            "cosmoteer.factory_uranium": { "mass": 12, "size": [3, 4] },
            "cosmoteer.storage_2x2": { "mass": 4, "size": [2, 2] },
            "cosmoteer.storage_3x2": { "mass": 6, "size": [3, 2] },
            "cosmoteer.storage_3x3": { "mass": 9, "size": [3, 3] },
            "cosmoteer.storage_4x3": { "mass": 12, "size": [4, 3] },
            "cosmoteer.storage_4x4": { "mass": 16, "size": [4, 4] },
            "cosmoteer.chaingun": { "mass": 17.77, "size": [3, 5], "sprite_size": [3, 7] },
            "cosmoteer.chaingun_magazine": { "mass": 2, "size": [1, 2] },
            "cosmoteer.hyperdrive_large": { "mass": 16, "size": [4, 4] },
            "cosmoteer.thruster_rocket_battery": { "mass": 2, "size": [1, 2] },
            "cosmoteer.thruster_rocket_extender": { "mass": 6, "size": [3, 2] },
            "cosmoteer.thruster_rocket_nozzle": { "mass": 14.4, "size": [3, 4], "sprite_size": [3, 5] },
            "cosmoteer.hyperdrive_med": { "mass": 9, "size": [3, 3] },
            "cosmoteer.manipulator_beam_emitter": { "mass": 4, "size": [2, 2] },
            "cosmoteer.crew_quarters_large": { "mass": 12, "size": [3, 4] }
        };

        // parts with special attributes
        const upTurrets = [
            "cosmoteer.laser_blaster_small",
            "cosmoteer.laser_blaster_large",
            "cosmoteer.disruptor",
            "cosmoteer.ion_beam_emitter",
            "cosmoteer.ion_beam_prism",
            "cosmoteer.point_defense",
            "cosmoteer.cannon_med",
            "cosmoteer.cannon_large",
            "cosmoteer.cannon_deck",
            "cosmoteer.missile_launcher",
            "cosmoteer.railgun_launcher",
            "cosmoteer.flak_cannon_large",
            "cosmoteer.shield_gen_small",
            "cosmoteer.chaingun",
        ]

        const downTurrets = [
            "cosmoteer.thruster_small",
            "cosmoteer.thruster_med",
            "cosmoteer.thruster_large",
            "cosmoteer.thruster_huge",
            "cosmoteer.thruster_boost",
        ]

        const multiple_turrets = ["cosmoteer.thruster_small_2way", "cosmoteer.thruster_small_3way"]

        const json_import_text = document.getElementById('jsonInput');
        const load_json_button = document.getElementById('loadButton');
        load_json_button.addEventListener('click', loadJson);
        const canvas = document.getElementById('spriteCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 64; // Size of each grid cell
        let sprites = [];
        let minX = 0, minY = 0, maxX = 0, maxY = 0; // adjust canvas size

        // Function to draw the grid
        function drawGrid() {
            ctx.strokeStyle = '#ccc';
            ctx.font = '12px Arial';
            ctx.fillStyle = '#000';

            for (let x = minX; x <= maxX; x++) {
                for (let y = minY; y <= maxY; y++) {
                    const xPos = (x - minX) * gridSize;
                    const yPos = (y - minY) * gridSize;
                    ctx.strokeRect(xPos, yPos, gridSize, gridSize);

                    // Draw coordinates
                    ctx.fillText(`(${x},${y})`, xPos + 2, yPos + 12);
                }
            }
        }

        function loadJson() {
            // Clear the sprite data
            sprites = [];
            const json = json_import_text.value;
            console.log(json);
            const data = JSON.parse(json);

            // Calculate the min and max positions
            minX = Infinity;
            minY = Infinity;
            maxX = -Infinity;
            maxY = -Infinity;

            data.forEach(sprite => {
                const [x, y] = sprite.Location;
                if (x < minX) minX = x;
                if (y < minY) minY = y;
                if (x > maxX) maxX = x;
                if (y > maxY) maxY = y;
                sprites.push(sprite);
            });

            // Extend the grid by 10 squares in each direction
            minX -= 10;
            minY -= 10;
            maxX += 10;
            maxY += 10;

            // Adjust canvas size
            const width = (maxX - minX + 1) * gridSize;
            const height = (maxY - minY + 1) * gridSize;
            canvas.width = width;
            canvas.height = height;

            redrawCanvas();
        }

        function sprite_position(part, position) {
            const sprite_size = spriteData[part["ID"]].sprite_size || spriteData[part["ID"]].size;
            const part_size = spriteData[part["ID"]].size;
            const part_rotation = part["Rotation"];

            if (part_rotation == 0 && upTurrets.includes(part["ID"])) {
                position[1] -= sprite_size[1] - part_size[1];
            } else if (part_rotation == 3 && upTurrets.includes(part["ID"])) {
                position[0] -= sprite_size[1] - part_size[1];
            } else if (part_rotation == 1 && downTurrets.includes(part["ID"])) {
                position[0] -= sprite_size[1] - part_size[1];
            } else if (part_rotation == 2 && downTurrets.includes(part["ID"])) {
                position[1] -= sprite_size[1] - part_size[1];
            } else if (multiple_turrets.includes(part["ID"])) {
                if (part["ID"] == "cosmoteer.thruster_small_2way") {
                    if (part_rotation == 1) {
                        position[0] -= 1;
                    }
                    if (part_rotation == 2) {
                        position[0] -= 1;
                        position[1] -= 1;
                    }
                    if (part_rotation == 3) {
                        position[1] -= 1;
                    }
                } else if (part["ID"] == "cosmoteer.thruster_small_3way") {
                    if (part_rotation == 1) {
                        position[0] -= 1;
                    }
                    if (part_rotation == 2) {
                        position[0] -= 1;
                        position[1] -= 1;
                    }
                    if (part_rotation == 3) {
                        position[1] -= 1;
                    }
                }
            }
            return position;
        }

        function rotate_img(image, angle, flipx) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Set canvas dimensions based on the rotation
            if (angle % 2 === 0) {
                canvas.width = image.width;
                canvas.height = image.height;
            } else {
                canvas.width = image.height;
                canvas.height = image.width;
            }

            // Translate to center and rotate
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(angle * Math.PI / 2);

            if (flipx) {
                ctx.scale(-1, 1);
            }

            ctx.drawImage(image, -image.width / 2, -image.height / 2);

            return canvas;
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
            drawGrid(); // Redraw the grid

            sprites.forEach(sprite => {
                const imageName = sprite["ID"].replace("cosmoteer.", "");
                const img = new Image();
                img.src = `sprites/${imageName}.png`;

                img.onload = () => {
                    let [x, y] = sprite_position(sprite, [sprite.Location[0], sprite.Location[1]]);
                    const rotatedImage = rotate_img(img, sprite.Rotation, sprite.FlipX);
                    ctx.drawImage(rotatedImage, (x - minX) * gridSize + 1, (y - minY) * gridSize + 1, rotatedImage.width - 2, rotatedImage.height - 2);
                };
            });
        }

        // Initialize the grid
        drawGrid();


    </script>
</body>

</html>