<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Placement</title>
    <style>
        canvas {
            border: 1px solid #000;
        }
        #previewSprite {
            position: absolute;
            opacity: 0.7;
            pointer-events: none; /* Allow interaction with canvas below */
        }
    </style>
</head>
<body>
    <canvas id="spriteCanvas" width="600" height="600"></canvas>
    <button id="exportButton">Export JSON</button>
    <label for="spriteSelect">Select a Sprite:</label>
    <select id="spriteSelect"></select>
    <button id="deleteButton">Delete</button>

    <script>
        let deleteMode = false;

        document.getElementById('deleteButton').addEventListener('click', toggleDeleteMode);

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            if (deleteMode) {
                clearPreviewSprite();
                document.body.style.cursor = 'crosshair'; // Change the cursor to indicate deletion mode
            } else {
                unclearPreviewSprite();
                document.body.style.cursor = 'default'; // Reset the cursor
            }
        }
        function clearPreviewSprite() {
            previewSprite.style.display = 'none'; // Hide the preview sprite
        }
        function unclearPreviewSprite() {
            previewSprite.style.display = 'block'; // Hide the preview sprite
        }

        const canvas = document.getElementById('spriteCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 10; // Size of each grid cell
        const sprites = [];
        const spriteData = {
    "cosmoteer.corridor":{"mass":1, "size":[1,1]},
    "cosmoteer.structure":{"mass":0.33, "size":[1,1]},
    "cosmoteer.structure_wedge":{"mass":0.17, "size":[1,1]},
    "cosmoteer.structure_1x2_wedge":{"mass":0.33, "size":[1,2]},
    "cosmoteer.structure_1x3_wedge":{"mass":0.5, "size":[1,3]},
    "cosmoteer.structure_tri":{"mass":0.08, "size":[1,1]},
    "cosmoteer.laser_blaster_small":{"mass":2.5, "size":[1,2], "sprite_size":[1,4]},
    "cosmoteer.laser_blaster_large":{"mass":7.68, "size":[2,3], "sprite_size":[2,6]},
    "cosmoteer.disruptor":{"mass":3.48, "size":[1,3], "sprite_size":[1,5]},
    "cosmoteer.ion_beam_emitter":{"mass":8, "size":[2,4], "sprite_size":[2,5], "rotation0": [0, -1]},
    "cosmoteer.resource_collector":{"mass":4, "size":[2,2]},
    "cosmoteer.ion_beam_prism":{"mass":7.7, "size":[2,2], "sprite_size":[2,2.5]},
    "cosmoteer.tractor_beam_emitter":{"mass":32.07, "size":[5,5]},
    "cosmoteer.point_defense":{"mass":1, "size":[1,1], "sprite_size":[1,2]},
    "cosmoteer.mining_laser_small":{"mass":7.4, "size":[2,3]},
    "cosmoteer.cannon_med":{"mass":4.44, "size":[2,1], "sprite_size":[2,3]},
    "cosmoteer.sensor_array":{"mass":11.54, "size":[3,3]},
    "cosmoteer.cannon_large":{"mass":12.29, "size":[3,2], "sprite_size":[3,5]},
    "cosmoteer.hyperdrive_beacon":{"mass":17.13, "size":[4,4]},
    "cosmoteer.cannon_deck":{"mass":27.07, "size":[4,5], "sprite_size":[4,7]},
    "cosmoteer.explosive_charge":{"mass":1, "size":[1,1]},
    "cosmoteer.roof_light":{"mass":1, "size":[1,1]},
    "cosmoteer.missile_launcher":{"mass":8, "size":[2,3], "sprite_size":[2,4]},
    "cosmoteer.roof_headlight":{"mass":1, "size":[1,1]},
    "cosmoteer.railgun_loader":{"mass":24, "size":[2,3]},
    "cosmoteer.armor_structure_hybrid_1x1":{"mass":1.5, "size":[1,1]},
    "cosmoteer.armor_structure_hybrid_1x2":{"mass":3, "size":[1,2]},
    "cosmoteer.railgun_accelerator":{"mass":36, "size":[2,3]},
    "cosmoteer.armor_structure_hybrid_1x3":{"mass":4.5, "size":[1,3]},
    "cosmoteer.armor_structure_hybrid_tri":{"mass":1, "size":[1,1]},
    "cosmoteer.railgun_launcher":{"mass":36, "size":[2,3], "sprite_size":[2,4]},
    "cosmoteer.armor":{"mass":3, "size":[1,1]},
    "cosmoteer.armor_2x1":{"mass":6, "size":[2,1]},
    "cosmoteer.flak_cannon_large":{"mass":16.77, "size":[3,6], "sprite_size":[3,8]},
    "cosmoteer.armor_wedge":{"mass":1.5, "size":[1,1]},
    "cosmoteer.armor_1x2_wedge":{"mass":3, "size":[1,2]},
    "cosmoteer.shield_gen_small":{"mass":6, "size":[2,2], "sprite_size":[2,3]},
    "cosmoteer.armor_1x3_wedge":{"mass":4.5, "size":[1,3]},
    "cosmoteer.armor_tri":{"mass":0.75, "size":[1,1]},
    "cosmoteer.shield_gen_large":{"mass":12.65, "size":[3,6]},
    "cosmoteer.thruster_small":{"mass":1.3, "size":[1,1], "sprite_size":[1,2]},
    "cosmoteer.thruster_med":{"mass":2.45, "size":[1,2], "sprite_size":[1,3]},
    "cosmoteer.thruster_large":{"mass":4.99, "size":[2,2], "sprite_size":[2,3]},
    "cosmoteer.thruster_boost":{"mass":8.88, "size":[2,3], "sprite_size":[2,5]},
    "cosmoteer.fire_extinguisher":{"mass":1, "size":[1,1]},
    "cosmoteer.thruster_huge":{"mass":11, "size":[3,3], "sprite_size":[3,5]},
    "cosmoteer.control_room_small":{"mass":4, "size":[2,2]},
    "cosmoteer.control_room_med":{"mass":9, "size":[3,3]},
    "cosmoteer.thruster_small_2way":{"mass":1.61, "size":[1,1], "sprite_size":[2,2]},
    "cosmoteer.control_room_large":{"mass":16, "size":[4,4]},
    "cosmoteer.thruster_small_3way":{"mass":1.91, "size":[1,1], "sprite_size":[3,2]},
    "cosmoteer.hyperdrive_small":{"mass":4, "size":[2,2]},
    "cosmoteer.engine_room":{"mass":9, "size":[3,3]},
    "cosmoteer.crew_quarters_small":{"mass":2, "size":[1,2]},
    "cosmoteer.crew_quarters_med":{"mass":4, "size":[2,2]},
    "cosmoteer.airlock":{"mass":1, "size":[1,1]},
    "cosmoteer.conveyor":{"mass":1, "size":[1,1]},
    "cosmoteer.reactor_small":{"mass":4, "size":[2,2]},
    "cosmoteer.reactor_med":{"mass":9, "size":[3,3]},
    "cosmoteer.reactor_large":{"mass":16, "size":[4,4]},
    "cosmoteer.power_storage":{"mass":4, "size":[2,2]},
    "cosmoteer.factory_ammo":{"mass":4, "size":[2,2]},
    "cosmoteer.factory_he":{"mass":9, "size":[3,3]},
    "cosmoteer.factory_emp":{"mass":12, "size":[3,4]},
    "cosmoteer.factory_nuke":{"mass":16, "size":[4,4]},
    "cosmoteer.factory_mine":{"mass":12, "size":[4,3]},
    "cosmoteer.factory_steel":{"mass":16, "size":[4,4]},
    "cosmoteer.factory_coil":{"mass":9, "size":[3,3]},
    "cosmoteer.factory_coil2":{"mass":12, "size":[4,3]},
    "cosmoteer.factory_tristeel":{"mass":16, "size":[4,4]},
    "cosmoteer.factory_diamond":{"mass":6, "size":[2,3]},
    "cosmoteer.factory_processor":{"mass":9, "size":[3,3]},
    "cosmoteer.factory_uranium":{"mass":12, "size":[3,4]},
    "cosmoteer.storage_2x2":{"mass":4, "size":[2,2]},
    "cosmoteer.storage_3x2":{"mass":6, "size":[3,2]},
    "cosmoteer.storage_3x3":{"mass":9, "size":[3,3]},
    "cosmoteer.storage_4x3":{"mass":12, "size":[4,3]},
    "cosmoteer.storage_4x4":{"mass":16, "size":[4,4]},
    "cosmoteer.chaingun":{"mass":16.82, "size":[3,5], "sprite_size":[3,7]},
    "cosmoteer.chaingun_magazine":{"mass":2, "size":[1,2]}
};
         // Create preview sprite
        const previewSprite = document.createElement('img');
        previewSprite.id = 'previewSprite';
        document.body.appendChild(previewSprite);
        canvas.addEventListener('mousemove', handleCanvasMouseMove);
        
        // add sprite to canvas when clicked
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('contextmenu', handleRightClick); // Listen for right-click
        document.getElementById('exportButton').addEventListener('click', exportToJson);

        let rotation = 0; // Initial rotation (0 degrees)

        // Function to draw the grid
        function drawGrid() {
            ctx.strokeStyle = '#ccc';
            for (let x = 0; x < canvas.width; x += gridSize) {
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.strokeRect(x, y, gridSize, gridSize);
                }
            }
        }

        // Function to handle mousemove and show the preview sprite
        function handleCanvasMouseMove(event) {
            const selectedSprite = document.getElementById('spriteSelect').value;
            if (spriteData[selectedSprite].sprite_size) {
                [width, height] = spriteData[selectedSprite].sprite_size;
            } else {
                [width, height] = spriteData[selectedSprite].size; // 3*3
            }

            // const [width, height] = spriteData[selectedSprite].size; // 3*3
            const x = event.offsetX; // mouse position x
            const y = event.offsetY; // mouse position y
            previewSprite.style.top = Math.floor((y - (height / 2) * gridSize + gridSize) / gridSize) * gridSize + 'px'; // laser is 1, 4 so top is mouse position - height/2
            previewSprite.style.height = height * gridSize + 'px';
            previewSprite.style.left = Math.floor((x - (width / 2) * gridSize + gridSize) / gridSize) * gridSize + 'px';
            previewSprite.style.width = (width * gridSize) + 'px';

            previewSprite.style.transformOrigin = 'center';
            previewSprite.style.transform = `rotate(${rotation * 90}deg)`;

            previewSprite.src = `sprites/${selectedSprite.replace("cosmoteer.", "")}.png`;
        }


        function handleCanvasClick(event) {
            const x = event.offsetX;
            const y = event.offsetY;

            if (deleteMode) {
                // Check if any sprite's boundaries contain the clicked point
                const indicesToRemove = sprites.reduce((indices, sprite, index) => {
                    const [width, height] = spriteData[sprite.name].size;
                    const spriteX = sprite.x;
                    const spriteY = sprite.y;
                    const spriteWidth = width * gridSize;
                    const spriteHeight = height * gridSize;

                    // Calculate sprite boundaries after rotation
                    const rotatedX = spriteX + gridSize;
                    const rotatedY = spriteY + gridSize;
                    const rotatedWidth = (sprite.rotation % 2 === 0) ? spriteWidth : spriteHeight;
                    const rotatedHeight = (sprite.rotation % 2 === 0) ? spriteHeight : spriteWidth;

                    // Check if the click is within the rotated sprite boundaries
                    if (mouseX >= rotatedX && mouseX <= rotatedX + rotatedWidth &&
                        mouseY >= rotatedY && mouseY <= rotatedY + rotatedHeight) {
                        indices.push(index);
                    }
                    return indices;
                }, []);

                // Remove the matched sprites
                indicesToRemove.forEach(index => {
                    sprites.splice(index, 1);
                });

                redrawCanvas(); // Redraw the canvas without the removed sprites
            } else {
                const selectedSprite = document.getElementById('spriteSelect').value;
                placeSprite(x, y, selectedSprite, rotation);
            }
        }


        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
            drawGrid(); // Redraw the grid

            // Redraw all placed sprites
            sprites.forEach(sprite => {
                const imageName = sprite.name.replace("cosmoteer.", "");
                const img = new Image();
                img.src = `sprites/${imageName}.png`;
                img.onload = () => {
                    ctx.translate(sprite.x + gridSize, sprite.y + gridSize);
                    ctx.rotate(sprite.rotation * (Math.PI / 2));
                    ctx.drawImage(img, -sprite.width * gridSize, -sprite.height * gridSize, sprite.width * gridSize, sprite.height * gridSize);
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                };
            });
        }

        // Function to handle right-click and rotate the preview sprite
        function handleRightClick(event) {
            event.preventDefault(); // Prevent the context menu from showing
            rotation = (rotation + 1) % 4; // Rotate 90 degrees clockwise
            console.log(rotation);
            handleCanvasMouseMove(event); // Update the preview sprite with the new rotation
        }

        // Function to place a sprite on the canvas
        function placeSprite(x, y, spriteName, rotation) {
            console.log(rotation);
            const spriteDataEntry = spriteData[spriteName];
            if (spriteDataEntry) {
                if (spriteData[spriteName].sprite_size) {
                    [width, height] = spriteData[spriteName].sprite_size;
                } else {
                    [width, height] = spriteData[spriteName].size; // 3*3
                }
                console.log("height" + height);
                console.log('y' + y);
                const ylocation = Math.floor((y - (height / 2) * gridSize + gridSize) / gridSize) * gridSize; // laser is 1, 4 so top is mouse position - height/2
                const xlocation = Math.floor((x - (width / 2) * gridSize + gridSize) / gridSize) * gridSize;
                console.log(xlocation/10-61, ylocation/10+1);
                console.log('y loc' + ylocation);
                // console.log(x, y);
                gridX = Math.floor((x - (width / 2) * gridSize + gridSize) / gridSize);
                gridY = Math.floor((y - (height / 2) * gridSize + gridSize) / gridSize);
                console.log('gridX' + gridX);
                console.log('gridY' + gridY);
                if (rotation === 0) {
                    if (spriteDataEntry.rotation0) {
                        offsetX = spriteDataEntry.rotation0[0];
                        offsetY = spriteDataEntry.rotation0[1];
                        gridY = gridY + offsetY;
                        gridX = gridX + offsetX;
                    }
                }
                const sprite = {
                    FlipX: false,
                    ID: spriteName,
                    Location: [gridX-61, Math.floor(gridY-1+height/2)],
                    Rotation: rotation,
                };

                // Adjust the placement to align with the bottom-right corner of the grid cell
                sprites.push(sprite);
                const imageName = spriteName.replace("cosmoteer.", "");

                const img = new Image();
                img.src = `sprites/${imageName}.png`;
                img.onload = () => {
                    ctx.rotate(rotation * (Math.PI / 2)); // Rotate by 90 degrees clockwise
                    ctx.drawImage(img, Math.floor((x - (width / 2) * gridSize + gridSize) / gridSize) * gridSize - gridSize, Math.floor((y - (height / 2) * gridSize + gridSize) / gridSize) * gridSize - gridSize, (width * gridSize), (height * gridSize));
                    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset the transformation matrix
                };
            }
        }


        // Function to export sprite data as JSON
        function exportToJson() {
            const json = JSON.stringify(sprites, null, 2);
            console.log(json); // You can replace this with code to download or display the JSON data
        }

        // Populate the sprite select dropdown with sprite names
        const spriteSelect = document.getElementById('spriteSelect');
        for (const spriteName in spriteData) {
            const option = document.createElement('option');
            option.value = spriteName;
            option.textContent = spriteName;
            spriteSelect.appendChild(option);
        }

        // Initialize the grid
        drawGrid();
    </script>
</body>
</html>